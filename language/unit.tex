\specsection{Declarations}

\begin{grammar}
\nonterminaldef{declarations} \\
	\optional{\terminal{export}} \nonterminal{declaration} \terminal{;} \optional{\nonterminal{declarations}} \\
	\nonterminal{static-assertion-expression} \terminal{;} \optional{\nonterminal{declarations}} \\

\nonterminaldef{declaration} \\
	\nonterminal{global-declaration} \\
	\nonterminal{constant-declaration} \\
	\nonterminal{type-declaration} \\
	\nonterminal{function-declaration} \\
\end{grammar}

A \nonterminal{declaration} specifies the interpretation and attributes of a set
of \nonterminal{identifier}s.

\specsubitem
The \nonterminal{identifier}s shall be visible anywhere within the current
translation unit. If the \terminal{export} keyword is used, the
\nonterminal{identifier}s shall be part of the unit's exported interface.

\specsubitem
The \terminal{export} keyword shall not be used with a
\nonterminal{function-declaration} which uses the \terminal{@init},
\terminal{@fini}, or \terminal{@test} attributes.

\specsubsection{Global declarations}

\begin{grammar}
\nonterminaldef{global-declaration} \\
	\terminal{let} \nonterminal{global-bindings} \\
	\terminal{const} \nonterminal{global-bindings} \\

\nonterminaldef{global-bindings} \\
	\nonterminal{global-binding} \optional{\terminal{,}} \\
	\nonterminal{global-bindings} \terminal{,} \nonterminal{global-binding} \\

\nonterminaldef{global-binding} \\
	\optional{\nonterminal{decl-attr}} \optional{\terminal{@threadlocal}} \nonterminal{identifier} \terminal{:} \nonterminal{type} \\
	\optional{\nonterminal{decl-attr}} \optional{\terminal{@threadlocal}} \nonterminal{identifier} \terminal{:} \nonterminal{type} \terminal{=} \nonterminal{expression} \\
	\optional{\nonterminal{decl-attr}} \optional{\terminal{@threadlocal}} \nonterminal{identifier} \terminal{=} \nonterminal{expression} \\

\nonterminaldef{decl-attr} \\
	\terminal{@symbol} \terminal{(} \nonterminal{string-constant} \terminal{)} \\
\end{grammar}

\specsubsubitem
In a \nonterminal{global-declaration}, sufficient space shall be reserved for
each \nonterminal{identifier} in the \nonterminal{global-bindings} to store
the type associated with it. That storage shall be initialized to the value of
the \nonterminal{expression} and shall have alignment greater than or equal to
the necessary alignment for the type. In the \terminal{const} form, the types
shall have the constant flag enabled by default.

\specsubsubitem
A \nonterminal{global-binding}'s \nonterminal{expression} shall be limited to
the \secref{Translation compatible expression subset}, and shall be evaluated
in the translation environment. If specified, the type of the value of the
\nonterminal{expression} shall be assignable to \nonterminal{type}. If not
specified, the type of the \nonterminal{global-binding} shall be the result
of the \nonterminal{expression}. Bindings whose type has undefined size shall
not be provided an \nonterminal{expression}.

\specsubsubitem
The first form of \nonterminal{global-binding} is a \textit{prototype}. In this
form, the implementation shall not allocate storage for the global, and the
programmer must arrange for storage to be provided elsewhere, the manner of
which is implementation-defined.

\specsubsubitem
The interpretation of the \terminal{@symbol} form of \nonterminal{decl-attr} is
implementation-defined. \terminal{@symbol} shall not be used alongside
\terminal{@init}, \terminal{@fini}, or \terminal{@test}.

\informative{The purpose of this directive is to allow users to customize the
symbol name emitted for targets like ELF.}

\specsubsubitem
The interpretation of \terminal{@threadlocal} is implementation-defined.

\informative{The purpose of this directive is to store a separate copy of a
global for each thread, similar to thread\_local in C.}

\specsubsection{Constant declarations}

\begin{grammar}
\nonterminaldef{constant-declaration} \\
	\terminal{def} \nonterminal{constant-bindings} \\

\nonterminaldef{constant-bindings} \\
	\nonterminal{constant-binding} \optional{\terminal{,}} \\
	\nonterminal{constant-bindings} \terminal{,} \nonterminal{constant-binding} \\

\nonterminaldef{constant-binding} \\
	\nonterminal{identifier} \terminal{:} \nonterminal{type} \terminal{=} \nonterminal{expression} \\
	\nonterminal{identifier} \terminal{=} \nonterminal{expression} \\
\end{grammar}

\specsubsubitem
In a \nonterminal{constant-declaration}, the \nonterminal{identifier}s in the
\nonterminal{constant-binding} shall be available to the translation
environment. No storage shall be allocated for them in the execution
environment, and they shall not be addressable. References to them shall be
equivalent to references to the \nonterminal{expression} associated with them,
with a cast to \nonterminal{type} inserted.

\specsubsubitem
A \nonterminal{constant-binding}'s \nonterminal{expression} shall be limited to
the \secref{Translation compatible expression subset}, and shall be evaluated
in the translation environment. If the first form of
\nonterminal{constant-binding} is given, the type of the value of the
\nonterminal{expression} shall be assignable to \nonterminal{type}.

\specsubsection{Type declarations}

\begin{grammar}
\nonterminaldef{type-declaration} \\
	\terminal{type} \nonterminal{type-bindings} \\

\nonterminaldef{type-bindings} \\
	\nonterminal{type-binding} \optional{\terminal{,}} \\
	\nonterminal{type-binding} \terminal{,} \nonterminal{type-bindings} \\

\nonterminaldef{type-binding} \\
	\nonterminal{identifier} \terminal{=} \nonterminal{type} \\
	\nonterminal{identifier} \terminal{=} \nonterminal{enum-type} \\

\nonterminaldef{enum-type} \\
	\terminal{enum} \optional{\nonterminal{enum-storage}} \terminal{\{} \nonterminal{enum-values} \terminal{\}} \\

\nonterminaldef{enum-values} \\
	\nonterminal{enum-value} \optional{\terminal{,}} \\
	\nonterminal{enum-value} \terminal{,} \nonterminal{enum-values} \\

\nonterminaldef{enum-value} \\
	\nonterminal{name} \\
	\nonterminal{name} \terminal{=} \nonterminal{expression} \\

\nonterminaldef{enum-storage} \\
	\nonterminal{integer-type} \\
	\terminal{rune} \\

\end{grammar}

\specsubsubitem
In a \nonterminal{type-declaration}, the \nonterminal{identifier}s shall
declare type aliases. In the first form of \nonterminal{type-binding}, the
underlying type for the \nonterminal{identifier} shall be the
\nonterminal{type}. In the second form, the underlying type shall be
\nonterminal{enum-storage}, if specified. Otherwise, the underlying type shall
be \terminal{int}.

\specsubsubitem
In the second form of \nonterminal{type-binding}, the enum values qualified
with the binding's \nonterminal{identifier} shall be made available to the
translation environment. No storage shall be allocated for them in the
execution environment, and they shall not be addressable.

\specsubsubitem
If the \nonterminal{enum-value} does not specify a \nonterminal{expression},
the value assigned to that \nonterminal{name} is equal to the last value
assigned to an \nonterminal{enum-value} of this enum type plus one. If no such
previous value exists, zero is assigned.

\specsubsubitem
An implicitly assigned \nonterminal{enum-value} shall not exceed the precision
of the underlying integer type; if it were to, a diagnostic message shall be
shown instead per \secref{Diagnostics}.

\specsubsubitem
\nonterminal{expression}, if specified, shall be evaluated in the translation
environment and the resulting value shall be assigned to the corresponding
\nonterminal{enum-value}. The \nonterminal{expression} shall be provided the
enum's type's underlying integer type as a type hint. The result type must be
assignable to the enum type's underlying integer type (ref
\subsecref{Assignment}).

\specsubsubitem
A temporary scope shall be allocated while declaring an enum type, and each value
name, in order, shall be made available to that scope.

\informative{This allows the \nonterminal{expression} for each value to refer
to previously declared values.}

\specsubsubitem
Each \nonterminal{enum-value}'s name shall be unique within the set of all
names of \nonterminal{enum-value}s of the \nonterminal{enum-type}. Otherwise, a
diagnostic message shall be printed and the translation phase shall be aborted.

\specsubsubitem
\nonterminal{expression} shall be limited to the
\secref{Translation compatible expression subset}.

\specsubsection{Function declarations}

\begin{grammar}
\nonterminaldef{function-declaration} \\
	\optional{\nonterminal{fndec-attrs}} \terminal{fn} \nonterminal{identifier} \nonterminal{prototype} \\
	\optional{\nonterminal{fndec-attrs}} \terminal{fn} \nonterminal{name} \nonterminal{prototype} \terminal{=} \nonterminal{expression} \\

\nonterminaldef{fndec-attrs} \\
	\nonterminal{fndec-attr} \\
	\nonterminal{fndec-attr} \nonterminal{fndec-attrs} \\

\nonterminaldef{fndec-attr} \\
	\terminal{@fini} \\
	\terminal{@init} \\
	\terminal{@test} \\
	\nonterminal{fntype-attr} \\
	\nonterminal{decl-attr} \\
\end{grammar}

\specsubsubitem
The first form of \nonterminal{function-declaration} is a \textit{prototype},
and shall cause the \nonterminal{identifier} to refer to the function type
described by the \nonterminal{prototype} and the function attributes. The
programmer must arrange for the implementation of this function to be provided
separately, the manner of which is implementation-defined. \terminal{@init},
\terminal{@fini}, and \terminal{@test} shall not be used on prototypes.

\specsubsubitem
The second form of \nonterminal{function-declaration} shall declare a function
and its implementation. The result type of the expression shall be assignable
to the prototype's result type. The function shall be available in the unit
scope by its \nonterminal{name}, and available to other units by forming a
fully-qualified identifier from the unit namespace and the \nonterminal{name}.

\specsubsubitem
In the second form of \nonterminal{function-declaration}, each
\nonterminal{parameter} in the \nonterminal{prototype} which uses the
\nonterminal{name} form shall be available within the \nonterminal{expression}
by its \nonterminal{name}. Those which do not use the \nonterminal{name} form
shall not be made available.

\specsubsubitem
The \terminal{@fini} form of \nonterminal{fndec-attr} shall cause the
function to be a \textit{finalization function}. \terminal{@init} shall cause it
to be an \textit{initialization function}. \terminal{@test} shall cause it to be
a \textit{test function}. If multiple \nonterminal{fndec-attr}s of the same type
are specified, the last one shall override all previous ones.

\specsubsubitem
Functions declared with \terminal{@test}, \terminal{@init}, or \terminal{@fini}
shall accept no parameters, shall return void, shall not be declared with
\terminal{@noreturn}, shall not appear in \nonterminal{object-selector}s, need
not have unique names, and shall not be inserted into the unit's scope.

\specsection{Units}

\begin{grammar}
\nonterminaldef{sub-unit}\\
	\optional{\nonterminal{imports}} \optional{\nonterminal{declarations}}\\

\nonterminaldef{imports}\\
	\nonterminal{use-statement}\\
	\nonterminal{use-statement} \nonterminal{imports}\\

\nonterminaldef{use-statement}\\
	\terminal{use} \optional{\nonterminal{import-alias}} \nonterminal{identifier} \terminal{;}\\
	\terminal{use} \optional{\nonterminal{import-alias}} \nonterminal{identifier} \terminal{::} \terminal{\{} \nonterminal{member-list} \terminal{\}} \terminal{;}\\
	\terminal{use} \nonterminal{identifier} \terminal{::} \terminal{*} \terminal{;}\\

\nonterminaldef{import-alias}\\
	\nonterminal{name} \terminal{=}\\

\nonterminaldef{member-list}\\
	\nonterminal{member} \optional{\terminal{,}}\\
	\nonterminal{member} \terminal{,} \nonterminal{member-list}\\

\nonterminaldef{member}\\
	\nonterminal{name}\\
	\nonterminal{name} \terminal{=} \nonterminal{name}\\
\end{grammar}

\specsubitem
A unit, or translation unit, is composed of several source files as described
by \secref{Translation steps}. Each source file is a \nonterminal{sub-unit}.
A specific sub-unit may have no declarations, but the unit shall contain at
least one declaration among its sub-units.

\specsubitem
An \nonterminal{import} shall declare a dependency between this translation
unit and another module of the namespace specified by the
\nonterminal{use-statement} \nonterminal{identifier}. This shall cause the named
module to be linked into the final program image as described by
\secref{Translation steps}.

\specsubitem
The first form of the \nonterminal{use-statement} shall cause the identifiers
exported by the target module to become visible to this \nonterminal{sub-unit}
in their fully-qualified form. Additionally, if the imported module has more
than one namespace, identifiers of the form "x::y" shall be made available,
where x is the most-specific namespace, and y is each of the exported members
of the target module.

\specsubitem
The second form of the \nonterminal{use-statement} shall cause only the members
listed in the \nonterminal{member-list}, qualified in the context of the target
namespace to become visible in their un-qualified form to this
\nonterminal{sub-unit}.

\specsubitem
A \nonterminal{member} in the first form shall become visible with the name
given by its definition in the target namespace. A \nonterminal{member} in the
second form shall become visible with the name given by the first
\nonterminal{name} in this form.

\informative{In the use statement \code{use bar::baz::\{bat\}}, identifier
\code{bar::baz::bat} may be referred to by its unqualified name \code{bat} in
the scope of this \nonterminal{sub-unit}.}

\specsubitem
The third form of the \nonterminal{use-statement} shall cause all identifiers
qualified in the context of the target namespace to become visible in their
un-qualified form to this \nonterminal{sub-unit}.

\specsubitem
The forms with \terminal{import-alias} shall be equivalent to the forms without
it except that the identifiers shall become visible under the namespace
described by the \nonterminal{name} given in this form.

\informative{In the use statement \code{use foo = bar::baz;}, identifiers in
the namespace \code{bar::baz} will be visible under the namespace \code{foo}.
For example, if the fully-qualified identifier \code{bar::baz::bat} exists, this
\nonterminal{sub-unit} may refer to it as \code{foo::bat}.}

\specsubitem
The translation unit shall establish a scope into which all
unit-local declarations are inserted. Each sub-unit shall establish another
scope as the parent scope of the unit scope, and in this sub-unit
scope, each of the imports used by that sub-unit shall be made available.

\informative{
In other words, declarations made in a sub-unit are visible to other members of
that unit, but imports in a sub-unit are not visible to other sub-units.}

