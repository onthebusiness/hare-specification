\specchapter{Program environment}

\specitem
The implementation translates source files and executes programs in two phases,
respectively referred to as the \textit{translation phase} and the
\textit{execution phase}. The context in which these phases occur is referred
to as the \textit{translation environment} and the \textit{execution
environment}.

\specsection{Translation environment}

\specsubitem
A Hare program consists of one or more \textit{source files} which are provided
to the translation phase. A source file is UTF-8 text.

\specsubitem
Each \textit{source file} is a member of exactly one \textit{module}, and the
collective source files for a module from a \textit{translation unit}. Each
module may define its own private types, data, procedure, and so on, for the
purpose of accomplish its tasks. It may also \textit{export} these types for
other modules to use.

\specsubitem
A Hare program may be translated incrementally, rather than all at one time.
However, the composite source files of a single translation unit must be
compiled together. Once compiled, an opaque representation of their
\textit{exported interface} (the sum of their exported types, data, and
procedures) provides sufficient information to translate other units which
require the module. The translated modules can be composed into the final
program at the last step.

\specsubitem
If the source files for a translation unit are not changed, the translated
module may be used repeatedly without repeating the translation step.

\specsection{Translation steps}

\specsubitem
The list of source files constituting the translation unit are identified. Steps
\subitemref{Translation steps}{2} and \subitemref{Translation steps}{3} are
repeated for each source file.

\specsubitem
Lexical analysis is conducted on the source file, translating it into a stream
of \textit{tokens}.

Forward references: \chref{Lexical analysis}

\specsubitem
Syntax analysis is conducted on the token stream, mapping the tokens to an
abstract syntax tree (AST). The Hare grammar shall define the relationships
between tokens necessary to produce a valid AST.

Forward references: \chref{Grammar}

\specsubitem
Logical analysis is conducted on the ASTs. In this step, the implementation
verifies that the constraints imposed on the program. The result of this step is
a \textit{verified program module}.

\informative{In this step, colloquially referred to as the "check" step, a
module composed of several source files is consolidated into a single verified
program module.}

\specsubitem
Once the verified program module is obtained in the translation phase, the
remainder of the translation phase shall be completed with no further
diagnostic messages, except in the case where external factors from the
execution environment prevent successful completion.

\example{Memory exhaustion or lack of disk space are situations which may cause
a failure in the remainder of the translation process.}

\specsubitem
The verified program module is combined with any applicable external modules and
translated into a single program image which is suitable for interpretation by
the execution environment.

\specsection{Execution environment}

\specsubitem
Two execution environments are defined: \textit{hosted} and
\textit{freestanding}. The implementation must support at least one environment.

\specsubitem
During \textit{program startup}, the execution environment shall initialize all
global declarations to their initial values, call all initialization functions
in an unspecified order, then transfer control to the program \textit{entry
point}. The manner of this initialization is implementation-defined.

% TODO: Should the order of initialization functions be defined by the
% dependency relationship between modules?

\specsubitem
During \textit{program teardown}, the execution environment shall call all
finalization functions in an unspecified order, then terminate.

Forward references: \secref{Initialization functions}, \secref{Finalization functions}

\specsubsection{The freestanding environment}

\specsubsubitem
The name and signature of the program entry point function is undefined in the
freestanding environment.

\specsubsection{The hosted environment}

\specsubsubitem
In the hosted environment, the program entry point shall be an exported
function named \code{main} in the global namespace. It shall have no parameters
and no result type.

\informative{The signature of a conformant entry point follows:}

\begin{codesample}
export fn main void;
\end{codesample}

\informative{The program shall provide this function in the global namespace.}

\specsubsection{Program execution}

\specsubsubitem
The evaluation of an expression may have \textit{side-effects} in addition to
computing a value. Calling a function or modifying an object is considered a
side-effect.

\specsubsubitem
If the implementation is able to determine that the evaluation of part of an
expression is not necessary to compute the correct value and cause the same
side-effects to occur in the same order, it may rewrite or re-order the
expressions or sub-expressions to produce the same results more optimally.

\informative{The interpretation of this constraint shall be conservative.
Implementations should prefer to be predictable over being fast. Programs which
require greater performance shall prefer to hand-optimize their source code for
this purpose.}

Forward references: \chref{Expressions}

\specsection{Diagnostics}

\specsubitem
If the constraints are found to be invalid during the translation phase, the
implementation shall display an error indicating which constraint was
invalidated, and indicate that the translation has failed in whatever manner is
semantically appropriate.

\informative{On a Unix system, the semantically appropriate indication of
failure is to exit with a non-zero status code.}

\specsubitem
In the translation environment, if the implementation is able to determine that
multiple constraints are invalid, it may display several diagnostic messages.

\specsubitem
If the constraints are found to be invalid during the execution phase, a hosted
implementation shall abort the execution phase, display a diagnostic message,
and indicate that the execution has failed in whatever manner is semantically
appropriate.
