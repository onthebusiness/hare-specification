\specchapter{Program environment}
% TODO: Forward references

\specitem
The implementation translates source files and executes programs in two phases,
respectively referred to as the \textit{translation phase} and the
\textit{execution phase}. The context in which these phases occur is referred
to as the \textit{translation environment} and the \textit{execution
environment}.

\specsection{Translation environment}

\specsubitem
A Hare program consists of one or more \textit{source files} which are provided
to the translation phase. A source file is UTF-8 text.

\specsubitem
Each \textit{source file} is a member of exactly one \textit{module}, and the
collective source files for a module from a \textit{translation unit}. Each
module may define its own private types, data, procedure, and so on, for the
purpose of accomplish its tasks. It may also \textit{export} these types for
other modules to use.

\specsubitem
A Hare program may be translated incrementally, rather than all at one time.
However, the composite source files of a single translation unit must be
compiled together. Once compiled, an opaque representation of their
\textit{exported interface} (the sum of their exported types, data, and
procedures) provides sufficient information to translate other units which
require the module. The translated modules can be composed into the final
program at the last step.

\specsubitem
If the source files for a translation unit are not changed, the translated
module may be used repeatedly without repeating the translation step.

\specsection{Translation steps}

\specsubitem
The list of source files constituting the translation unit are identified. Steps
\subitemref{Translation steps}{2} and \subitemref{Translation steps}{3} are
repeated for each source file.

\specsubitem
Lexical analysis is conducted on the source file, translating it into a stream
of \textit{tokens} (see \chref{Lexical tokens}).

\specsubitem
Grammatical analysis is conducted on the token stream, mapping the tokens to an
abstract syntax tree (AST). The organizational model of this syntax tree shall
be consistent with the grammar defined by \chref{Grammar}.

\specsubitem
Logical analysis is conducted on the ASTs. In this step, the implementation
verifies that the constraints imposed on the program. The result of this step is
a \textit{verified program module}.

\informative{In this step, a module composed of several source files is
consolidated into a single verified program module.}

\specsubitem
Once the verified program module is obtained in the translation phase, the
remainder of the translation phase shall be completed with no further
diagnostic messages, except in the case where external factors from the
execution environment prevent successful completion.

\example{Memory exhaustion or lack of disk space are situations which may cause
a failure in the remainder of the translation process.}

\specsubitem
The verified program module is combined with any applicable external modules and
translated into a single program image which is suitable for interpretation by
the execution environment.

\specsection{Execution environment}

\specsubitem
Two execution environments are defined: \textit{hosted} and
\textit{freestanding}.

\specsubitem
During \textit{program startup}, the execution environment shall initialize all
global declarations to their initial values, call all initialization functions
in an unspecified order, then transfer control to the program \textit{entry
point}. The manner of this initialization is implementation defined.

% TODO: Should the order of initialization functions be defined by the
% dependency relationship between modules?

\specsubitem
During \textit{program teardown}, the execution environment shall call all
finalization functions in an unspecified order, then terminate.

\specsection{Diagnostics}

\specsubitem
If the constraints are found to be invalid during the translation phase, the
implementation shall display an error indicating which constraint was
invalidated, and indicate that the translation has failed in whatever manner is
semantically appropriate.

\informative{On a Unix system, the semantically appropriate indication of
failure is to exit with a non-zero status code.}

\specsubitem
In the translation environment, if the implementation is able to determine that
multiple constraints are invalid, it may display several diagnostic messages.

\specsubitem
If the constraints are found to be invalid during the execution phase, a hosted
implementation shall abort the execution phase, display a diagnostic message,
and indicate that the execution has failed in whatever manner is semantically
appropriate.
